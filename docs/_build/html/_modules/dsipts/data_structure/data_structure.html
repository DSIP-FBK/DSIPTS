<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>dsipts.data_structure.data_structure &mdash; DISIPTS 0.0.1 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            DISIPTS
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">dsipts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../bash_examples.html">bash_examples package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">DISIPTS</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">dsipts.data_structure.data_structure</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for dsipts.data_structure.data_structure</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">import</span> <span class="nn">plotly.express</span> <span class="k">as</span> <span class="nn">px</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">LabelEncoder</span><span class="p">,</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span>
<span class="kn">from</span> <span class="nn">pytorch_lightning.callbacks</span> <span class="kn">import</span> <span class="n">ModelCheckpoint</span>
<span class="kn">import</span> <span class="nn">pytorch_lightning</span> <span class="k">as</span> <span class="nn">pl</span>
<span class="kn">from</span> <span class="nn">pytorch_lightning.loggers</span> <span class="kn">import</span> <span class="n">CSVLogger</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">chained_assignment</span> <span class="o">=</span> <span class="kc">None</span> 
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">extend_df</span><span class="p">,</span><span class="n">MetricsCallback</span><span class="p">,</span> <span class="n">MyDataset</span><span class="p">,</span> <span class="n">ActionEnum</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">..models.base</span> <span class="kn">import</span> <span class="n">Base</span>
<span class="kn">from</span> <span class="nn">..models.utils</span> <span class="kn">import</span> <span class="n">weight_init</span>
<span class="kn">import</span> <span class="nn">logging</span> 
<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">log</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">NullHandler</span><span class="p">())</span>      
      
      
<div class="viewcode-block" id="Categorical"><a class="viewcode-back" href="../../../dsipts.data_structure.html#dsipts.data_structure.data_structure.Categorical">[docs]</a><span class="k">class</span> <span class="nc">Categorical</span><span class="p">():</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">frequency</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span><span class="n">duration</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">classes</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="n">ActionEnum</span><span class="p">,</span>  <span class="n">level</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Class for generating toy categorical data</span>

<span class="sd">        Args:</span>
<span class="sd">            name (str): name of the categorical signal</span>
<span class="sd">            frequency (int): frequency of the signal</span>
<span class="sd">            duration (List[int]): duration of each class</span>
<span class="sd">            classes (int): number of classes</span>
<span class="sd">            action (str): one between additive or multiplicative</span>
<span class="sd">            level (List[float]): intensity of each class</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">frequency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="n">duration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classes</span> <span class="o">=</span> <span class="n">classes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">action</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">level</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate, maybe there will be other checks in the future</span>
<span class="sd">        </span>
<span class="sd">        :meta private:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">classes</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Length must match&quot;</span><span class="p">)</span>
        

            

    
<div class="viewcode-block" id="Categorical.generate_signal"><a class="viewcode-back" href="../../../dsipts.data_structure.html#dsipts.data_structure.data_structure.Categorical.generate_signal">[docs]</a>    <span class="k">def</span> <span class="nf">generate_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">length</span><span class="p">:</span><span class="nb">int</span><span class="p">)</span><span class="o">-&gt;</span><span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate the resposne signal</span>

<span class="sd">        Args:</span>
<span class="sd">            length (int): length of the signal</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span>  <span class="o">==</span> <span class="s1">&#39;multiplicative&#39;</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;additive&#39;</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>
        <span class="n">classes</span> <span class="o">=</span> <span class="p">[]</span>    
        <span class="n">_class</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">_duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">count_freq</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">count_freq</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">frequency</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">signal</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_level</span>
                <span class="n">classes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_class</span><span class="p">)</span>
                <span class="n">count</span><span class="o">+=</span><span class="mi">1</span>
                <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="n">_duration</span><span class="p">:</span>
                    <span class="c1">#change class</span>
                    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">_class</span><span class="o">+=</span><span class="mi">1</span>
                    <span class="n">count_freq</span><span class="o">+=</span> <span class="n">_duration</span>
                    <span class="n">_class</span> <span class="o">=</span> <span class="n">_class</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">classes</span>
                    <span class="n">_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">[</span><span class="n">_class</span><span class="p">]</span>
                    <span class="n">_duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="p">[</span><span class="n">_class</span><span class="p">]</span>

                   
            <span class="k">else</span><span class="p">:</span>
                <span class="n">classes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">count_freq</span><span class="o">+=</span><span class="mi">1</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">classes_array</span> <span class="o">=</span> <span class="n">classes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signal_array</span> <span class="o">=</span> <span class="n">signal</span></div>

<div class="viewcode-block" id="Categorical.plot"><a class="viewcode-back" href="../../../dsipts.data_structure.html#dsipts.data_structure.data_structure.Categorical.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot the series</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;time&#39;</span><span class="p">:</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">classes_array</span><span class="p">)),</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">signal</span><span class="p">,</span><span class="s1">&#39;class&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">classes_array</span><span class="p">})</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="s1">&#39;signal&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;class&#39;</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div></div>

 
<div class="viewcode-block" id="TimeSeries"><a class="viewcode-back" href="../../../dsipts.data_structure.html#dsipts.data_structure.data_structure.TimeSeries">[docs]</a><span class="k">class</span> <span class="nc">TimeSeries</span><span class="p">():</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Class for generating time series object. If you don&#39;t have any time series you can build one fake timeseries using some helping classes (Categorical for instance).</span>


<span class="sd">        Args:</span>
<span class="sd">            name (str): name of the series</span>
<span class="sd">                </span>
<span class="sd">                </span>
<span class="sd">        Usage:</span>
<span class="sd">            For example we can generate a toy timeseries:\n</span>
<span class="sd">            - add a multiplicative categorical feature (weekly)\n</span>
<span class="sd">            &gt;&gt;&gt; settimana = Categorical(&#39;settimanale&#39;,1,[1,1,1,1,1,1,1],7,&#39;multiplicative&#39;,[0.9,0.8,0.7,0.6,0.5,0.99,0.99])\n</span>
<span class="sd">            - an additive montly feature (here a year is composed by 5 months)\n</span>
<span class="sd">            &gt;&gt;&gt; mese = Categorical(&#39;mensile&#39;,1,[31,28,20,10,33],5,&#39;additive&#39;,[10,20,-10,20,0])\n</span>
<span class="sd">            - a spotted categorical variable that happens every 100 days and lasts 1 day\n</span>
<span class="sd">            &gt;&gt;&gt; spot = Categorical(&#39;spot&#39;,100,[7],1,&#39;additive&#39;,[10])\n</span>
<span class="sd">            &gt;&gt;&gt; ts = TimeSeries(&#39;prova&#39;)\n</span>
<span class="sd">            &gt;&gt;&gt; ts.generate_signal(length = 5000,categorical_variables = [settimana,mese,spot],noise_mean=1,type=0) ##we can add also noise\n</span>
<span class="sd">            &gt;&gt;&gt; ts.plot()\n</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Timeseries named </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> of length </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2"> Categorical variable: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_var</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2"> Future variables: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">future_variables</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2"> Past variables: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">past_variables</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2"> Target variables: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target_variables</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Timeseries named </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> of length </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2"> Categorical variable: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_var</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2"> Future variables: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">future_variables</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2"> Past variables: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">past_variables</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2"> Target variables: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target_variables</span><span class="si">}</span><span class="s2">&quot;</span>
    
    <span class="k">def</span> <span class="nf">_generate_base</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">length</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span><span class="nb">type</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a basic timeseries </span>

<span class="sd">        Args:</span>
<span class="sd">            length (int): length</span>
<span class="sd">            type (int, optional): Type of the generated timeseries. Defaults to 0.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_signal</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">length</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">length</span><span class="o">/</span><span class="mi">100</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out_vars</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Please implement your own method&#39;</span><span class="p">)</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>    
<div class="viewcode-block" id="TimeSeries.generate_signal"><a class="viewcode-back" href="../../../dsipts.data_structure.html#dsipts.data_structure.data_structure.TimeSeries.generate_signal">[docs]</a>    <span class="k">def</span> <span class="nf">generate_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">length</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span><span class="n">categorical_variables</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="n">Categorical</span><span class="p">]</span><span class="o">=</span><span class="p">[],</span><span class="n">noise_mean</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="nb">type</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This will generate a syntetic signal with a selected length, a noise level and some categorical variables. The additive series are added at the end while the multiplicative series acts on the original signal</span>
<span class="sd">        The TS structure will be populated</span>

<span class="sd">        Args:</span>
<span class="sd">            length (int, optional): length of the signal. Defaults to 5000.</span>
<span class="sd">            categorical_variables (List[Categorical], optional): list of Categorical variables. Defaults to [].</span>
<span class="sd">            noise_mean (int, optional): variance of the noise to add at the end. Defaults to 1.</span>
<span class="sd">            type (int, optional): type of the timeseries (only type=0 available right now). Defaults to 0.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
       
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;time&#39;</span><span class="p">:</span><span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">)})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_generate_base</span><span class="p">(</span><span class="n">length</span><span class="p">,</span><span class="nb">type</span><span class="p">)</span>
        <span class="n">signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_signal</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">tot</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cat_var</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">categorical_variables</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">generate_signal</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>
            <span class="n">_signal</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">signal_array</span>
            <span class="n">classes</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">classes_array</span>
            <span class="n">dataset</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">classes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cat_var</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">action</span><span class="o">==</span><span class="s1">&#39;multiplicative&#39;</span><span class="p">:</span>
                <span class="n">signal</span><span class="o">*=</span><span class="n">_signal</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">additive</span> <span class="o">=</span> <span class="n">_signal</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">additive</span><span class="o">+=</span><span class="n">_signal</span>
        <span class="n">signal</span><span class="o">+=</span><span class="n">additive</span>
        <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">signal</span> <span class="o">+</span> <span class="n">noise_mean</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">signal</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span>
        
        
        <span class="bp">self</span><span class="o">.</span><span class="n">past_variables</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">future_variables</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_variables</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_var</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">past_variables</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">future_variables</span><span class="p">))</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_variables</span><span class="p">)))</span></div>
        
        
        
<div class="viewcode-block" id="TimeSeries.load_signal"><a class="viewcode-back" href="../../../dsipts.data_structure.html#dsipts.data_structure.data_structure.TimeSeries.load_signal">[docs]</a>    <span class="k">def</span> <span class="nf">load_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span><span class="n">enrich_cat</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span><span class="n">past_variables</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="p">[],</span><span class="n">future_variables</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="p">[],</span><span class="n">target_variables</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="p">[],</span><span class="n">cat_var</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="p">[],</span><span class="n">check_past</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">-&gt;</span><span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; This is a crucial point in the data structure. We expect here to have a dataset with time as timestamp.</span>
<span class="sd">            There are some checks:</span>
<span class="sd">                1- the duplicates will tbe removed taking the first instance</span>
<span class="sd">                2- the frequency will the inferred taking the minumum time distance between samples</span>
<span class="sd">                3- the dataset will be filled completing the missing timestamps</span>

<span class="sd">        Args:</span>
<span class="sd">            data (pd.DataFrame): input dataset the column indicating the time must be called `time`</span>
<span class="sd">            enrich_cat (List[str], optional): it is possible to let this function enrich the dataset for example adding the standard columns: hour, dow, month and minute. Defaults to [].</span>
<span class="sd">            past_variables (List[str], optional): list of column names of past variables not available for future times . Defaults to [].</span>
<span class="sd">            future_variables (List[str], optional): list of future variables available for tuture times. Defaults to [].</span>
<span class="sd">            target_variables (List[str], optional): list of the target variables. They will added to past_variables by default unless `check_past` is false. Defaults to [].</span>
<span class="sd">            cat_var (List[str], optional): list of the categortial variables (same for past and future). Defaults to [].</span>
<span class="sd">            check_past (bool, optional): see `target_variables`. Defaults to True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        
        
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;################I will drop duplicates, I dont like them###################&#39;</span><span class="p">)</span>
        <span class="n">dataset</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span>  <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">diff</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;#########There are holes in the dataset i will try to extend the dataframe inserting NAN#############3&quot;</span><span class="p">)</span>
            <span class="n">freq</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">time</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;#############Detected minumum frequency: </span><span class="si">{</span><span class="n">freq</span><span class="si">}</span><span class="s1">#############&#39;</span><span class="p">)</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">extend_df</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">time</span><span class="p">,</span><span class="n">freq</span><span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
            

            
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_variables</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Provide at least one column for target&#39;</span>
        <span class="k">assert</span> <span class="s1">&#39;time&#39;</span>  <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;The temporal column must be called time&#39;</span>
        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">target_variables</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">past_variables</span><span class="p">))</span><span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">target_variables</span><span class="p">):</span> 
            <span class="k">if</span> <span class="n">check_past</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;##########I will update past column adding all target columns, if you want to avoid this beahviour please use check_pass as false############&#39;</span><span class="p">)</span>
                <span class="n">past_variables</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">past_variables</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">target_variables</span><span class="p">)))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">cat_var</span> <span class="o">=</span> <span class="n">cat_var</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enrich_cat</span> <span class="o">=</span> <span class="n">enrich_cat</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">enrich_cat</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cat_var</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_var</span><span class="o">+</span><span class="p">[</span><span class="n">c</span><span class="p">]))</span>
                
            <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;#########Categorical </span><span class="si">{c}</span><span class="s1"> already present, it will be added to categorical variable but not recomputed#########&#39;</span><span class="p">)</span> 
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c</span> <span class="o">==</span><span class="s1">&#39;hour&#39;</span><span class="p">:</span>
                    <span class="n">dataset</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">hour</span>
                <span class="k">elif</span> <span class="n">c</span><span class="o">==</span><span class="s1">&#39;dow&#39;</span><span class="p">:</span>
                    <span class="n">dataset</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">weekday</span>
                <span class="k">elif</span> <span class="n">c</span><span class="o">==</span><span class="s1">&#39;month&#39;</span><span class="p">:</span>
                    <span class="n">dataset</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span>
                <span class="k">elif</span> <span class="n">c</span><span class="o">==</span><span class="s1">&#39;minute&#39;</span><span class="p">:</span>
                    <span class="n">dataset</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">minute</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;I can not automatically add column </span><span class="si">{c}</span><span class="s1"> plase update this function accordlyng&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">past_variables</span> <span class="o">=</span><span class="n">past_variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">future_variables</span> <span class="o">=</span> <span class="n">future_variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_variables</span> <span class="o">=</span> <span class="n">target_variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_vars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_variables</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_var</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">past_variables</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">future_variables</span><span class="p">))</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_variables</span><span class="p">)))</span></div>
        
<div class="viewcode-block" id="TimeSeries.plot"><a class="viewcode-back" href="../../../dsipts.data_structure.html#dsipts.data_structure.data_structure.TimeSeries.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;  </span>
<span class="sd">        Easy way to control the loaded data</span>
<span class="sd">        Returns:</span>
<span class="sd">            plotly.graph_objects._figure.Figure: figure of the target variables</span>
<span class="sd">        &quot;&quot;&quot;</span>
      
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;plotting only target variables&#39;</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">target_variables</span><span class="p">]</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;variable&#39;</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">fig</span></div>
    
        
<div class="viewcode-block" id="TimeSeries.create_data_loader"><a class="viewcode-back" href="../../../dsipts.data_structure.html#dsipts.data_structure.data_structure.TimeSeries.create_data_loader">[docs]</a>    <span class="k">def</span> <span class="nf">create_data_loader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span><span class="n">past_steps</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span><span class="n">future_steps</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span><span class="n">shift</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">starting_point</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="nb">dict</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">skip_step</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">MyDataset</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Create the dataset for the training/inference step</span>

<span class="sd">        Args:</span>
<span class="sd">            data (pd.DataFrame): input dataset, usually a subset of self.data</span>
<span class="sd">            past_steps (int): past context length</span>
<span class="sd">            future_steps (int): future lags to predict</span>
<span class="sd">            shift (int, optional): if &gt;0 the future input variables will be shifted (categorical and numerical). For example for attention model it is better to start with a know value of y and use it during the process. Defaults to 0.</span>
<span class="sd">            starting_point (Union[None,dict], optional): a dictionary indicating if a sample must be considered. It is checked for the first lag in the future (useful in the case your model has to predict only starting from hour 12). Defaults to None.</span>
<span class="sd">            skip_step (int, optional): list of the categortial variables (same for past and future). Usual there is a skip of one between two saples but for debugging  or training time purposes you can skip some samples. Defaults to 1.</span>

<span class="sd">        Returns:</span>
<span class="sd">            MyDataset: class thath extends torch.utils.data.Dataset (see utils)</span>
<span class="sd">                keys of a batch:</span>
<span class="sd">                y : the target variable(s)</span>
<span class="sd">                x_num_past: the numerical past variables</span>
<span class="sd">                x_num_future: the numerical future variables</span>
<span class="sd">                x_cat_past: the categorical past variables</span>
<span class="sd">                x_cat_future: the categorical future variables</span>
<span class="sd">                idx_target: index of target features in the past array</span>
<span class="sd">        &quot;&quot;&quot;</span>

        
        <span class="n">x_num_past_samples</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">x_num_future_samples</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">x_cat_past_samples</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">x_cat_future_samples</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">y_samples</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">t_samples</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_var</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler_cat</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_var</span><span class="p">:</span> 
            <span class="n">data</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler_num</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        
        <span class="n">idx_target</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_variables</span><span class="p">:</span>
            <span class="n">idx_target</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">past_variables</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
         
        
        <span class="n">x_num_past</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">past_variables</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">future_variables</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">x_num_future</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">future_variables</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_var</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">x_cat</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y_target</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_variables</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span>

        <span class="c1">##questo serve a forzare di iniziare i samples alla stessa ora per esempio (controllo sul primo indice della y)</span>
        <span class="k">if</span> <span class="n">starting_point</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">check</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">starting_point</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">starting_point</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">starting_point</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">check</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">y_target</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">past_steps</span><span class="p">,</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">future_steps</span><span class="p">,</span><span class="n">skip_step</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">check</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">future_variables</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">xx</span> <span class="o">=</span> <span class="n">x_num_future</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">shift</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">future_steps</span><span class="o">-</span><span class="n">shift</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">xx</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">x_num_past</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">past_steps</span><span class="p">:</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">+</span> <span class="n">y_target</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">future_steps</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">+</span> <span class="n">xx</span><span class="p">):</span>
                    
                    <span class="n">x_num_past_samples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_num_past</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">past_steps</span><span class="p">:</span><span class="n">i</span><span class="p">])</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">future_variables</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">x_num_future_samples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_num_future</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">shift</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">future_steps</span><span class="o">-</span><span class="n">shift</span><span class="p">])</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_var</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">x_cat_past_samples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_cat</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">past_steps</span><span class="p">:</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">x_cat_future_samples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_cat</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">shift</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">future_steps</span><span class="o">-</span><span class="n">shift</span><span class="p">])</span>
                    <span class="n">y_samples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_target</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">future_steps</span><span class="p">])</span>
                    <span class="n">t_samples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">future_steps</span><span class="p">])</span>
            
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">future_variables</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">x_num_future_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">x_num_future_samples</span><span class="p">)</span>
        <span class="n">y_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">y_samples</span><span class="p">)</span>

        <span class="n">t_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">t_samples</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_var</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">x_cat_past_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">x_cat_past_samples</span><span class="p">)</span>
            <span class="n">x_cat_future_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">x_cat_future_samples</span><span class="p">)</span>
        <span class="n">x_num_past_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">x_num_past_samples</span><span class="p">)</span>
        
        <span class="n">dd</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;y&#39;</span><span class="p">:</span><span class="n">y_samples</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>

              <span class="s1">&#39;x_num_past&#39;</span><span class="p">:</span><span class="n">x_num_past_samples</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)}</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_var</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;x_cat_past&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_cat_past_samples</span>
            <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;x_cat_future&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_cat_future_samples</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">future_variables</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;x_num_future&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_num_future_samples</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">MyDataset</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span><span class="n">t_samples</span><span class="p">,</span><span class="n">idx_target</span><span class="p">)</span></div>
    
          
    
<div class="viewcode-block" id="TimeSeries.split_for_train"><a class="viewcode-back" href="../../../dsipts.data_structure.html#dsipts.data_structure.data_structure.TimeSeries.split_for_train">[docs]</a>    <span class="k">def</span> <span class="nf">split_for_train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                        <span class="n">perc_train</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
                        <span class="n">perc_valid</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                        <span class="n">range_train</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">datetime</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span><span class="kc">None</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">range_validation</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">datetime</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span><span class="kc">None</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">range_test</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">datetime</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span><span class="kc">None</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">past_steps</span><span class="p">:</span><span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
                        <span class="n">future_steps</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                        <span class="n">shift</span><span class="p">:</span><span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="n">starting_point</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">skip_step</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">1</span>
                        <span class="p">)</span><span class="o">-&gt;</span><span class="n">List</span><span class="p">[</span><span class="n">DataLoader</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Split the data and create the datasets.</span>

<span class="sd">        Args:</span>
<span class="sd">            perc_train (Union[float,None], optional): fraction of the training set. Defaults to 0.6.</span>
<span class="sd">            perc_valid (Union[float,None], optional): fraction of the test set. Defaults to 0.2.</span>
<span class="sd">            range_train (Union[List[Union[datetime, str]],None], optional): a list of two elements indicating the starting point and end point of the training set (string date style or datetime). Defaults to None.</span>
<span class="sd">            range_validation (Union[List[Union[datetime, str]],None], optional):a list of two elements indicating the starting point and end point of the validation set (string date style or datetime). Defaults to None.</span>
<span class="sd">            range_test (Union[List[Union[datetime, str]],None], optional): a list of two elements indicating the starting point and end point of the test set (string date style or datetime). Defaults to None.</span>
<span class="sd">            past_steps (int, optional): past step to consider for making the prediction. Defaults to 100.</span>
<span class="sd">            future_steps (int, optional): future step to predict. Defaults to 20.</span>
<span class="sd">            shift (int, optional): see `create_data_loader`. Defaults to 0.</span>
<span class="sd">            starting_point (Union[None, dict], optional):  see `create_data_loader`. Defaults to None.</span>
<span class="sd">            skip_step (int, optional):  see `create_data_loader`. Defaults to 1.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[DataLoader,DataLoader,DataLoader]: three dataloader used for training or inference</span>
<span class="sd">        &quot;&quot;&quot;</span>

        
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Empty dataset&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        

        <span class="k">if</span> <span class="n">range_train</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Split temporally using perc_train: </span><span class="si">{</span><span class="n">perc_train</span><span class="si">}</span><span class="s1"> and perc_valid:</span><span class="si">{</span><span class="n">perc_valid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
            <span class="n">train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">int</span><span class="p">(</span><span class="n">perc_train</span><span class="o">*</span><span class="n">l</span><span class="p">)]</span>
            <span class="n">validation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">perc_train</span><span class="o">*</span><span class="n">l</span><span class="p">):</span><span class="nb">int</span><span class="p">(</span><span class="n">perc_train</span><span class="o">*</span><span class="n">l</span><span class="o">+</span><span class="n">perc_valid</span><span class="o">*</span><span class="n">l</span><span class="p">)]</span>
            <span class="n">test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">perc_train</span><span class="o">*</span><span class="n">l</span><span class="o">+</span><span class="n">perc_valid</span><span class="o">*</span><span class="n">l</span><span class="p">):]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Split temporally using the time intervals provided&#39;</span><span class="p">)</span>

            <span class="n">train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="n">range_train</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">range_train</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
            <span class="n">validation</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="n">range_validation</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">range_validation</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
            <span class="n">test</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="n">range_test</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">range_test</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
                                      
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler_cat</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler_num</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;######################################################################################################&#39;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;######Scaling numerical (standard scaler) and categorical (label encorer) on the training data! ######&#39;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;######################################################################################################&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_var</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scaler_num</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span>  <span class="n">StandardScaler</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scaler_num</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_var</span><span class="p">:</span>                               
            <span class="bp">self</span><span class="o">.</span><span class="n">scaler_cat</span> <span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span>  <span class="n">LabelEncoder</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scaler_cat</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>  
                                      
    
        <span class="n">dl_train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_data_loader</span><span class="p">(</span><span class="n">train</span><span class="p">,</span><span class="n">past_steps</span><span class="p">,</span><span class="n">future_steps</span><span class="p">,</span><span class="n">shift</span><span class="p">,</span><span class="n">starting_point</span><span class="p">,</span><span class="n">skip_step</span><span class="p">)</span>
        <span class="n">dl_validation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_data_loader</span><span class="p">(</span><span class="n">validation</span><span class="p">,</span><span class="n">past_steps</span><span class="p">,</span><span class="n">future_steps</span><span class="p">,</span><span class="n">shift</span><span class="p">,</span><span class="n">starting_point</span><span class="p">,</span><span class="n">skip_step</span><span class="p">)</span>
        <span class="n">dl_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_data_loader</span><span class="p">(</span><span class="n">test</span><span class="p">,</span><span class="n">past_steps</span><span class="p">,</span><span class="n">future_steps</span><span class="p">,</span><span class="n">shift</span><span class="p">,</span><span class="n">starting_point</span><span class="p">,</span><span class="n">skip_step</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dl_train</span><span class="p">,</span><span class="n">dl_validation</span><span class="p">,</span><span class="n">dl_test</span></div>
            
<div class="viewcode-block" id="TimeSeries.set_model"><a class="viewcode-back" href="../../../dsipts.data_structure.html#dsipts.data_structure.data_structure.TimeSeries.set_model">[docs]</a>    <span class="k">def</span> <span class="nf">set_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model</span><span class="p">:</span><span class="n">Base</span><span class="p">,</span><span class="n">config</span><span class="p">:</span><span class="nb">dict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the model to train</span>

<span class="sd">        Args:</span>
<span class="sd">            model (Base): see `models`</span>
<span class="sd">            config (dict, optional): usually the configuration used by the model. Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;######################################################################################################&#39;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;###########LOOK THE INIT PROCEDURE IF YOU NEED A CUSTOM INITIALIZATION of the weighjts################&#39;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;######################################################################################################&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">weight_init</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;######################################################################################################&#39;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;######################################################MODEL###########################################&#39;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;######################################################################################################&#39;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">model</span><span class="p">)</span></div>
              
<div class="viewcode-block" id="TimeSeries.train_model"><a class="viewcode-back" href="../../../dsipts.data_structure.html#dsipts.data_structure.data_structure.TimeSeries.train_model">[docs]</a>    <span class="k">def</span> <span class="nf">train_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dirpath</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
                    <span class="n">split_params</span><span class="p">:</span><span class="nb">dict</span><span class="p">,</span>
                    <span class="n">batch_size</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                    <span class="n">num_workers</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                    <span class="n">max_epochs</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
                    <span class="n">auto_lr_find</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">gradient_clip_val</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">gradient_clip_algorithm</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="p">,</span>
                    <span class="n">devices</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
                    <span class="n">precision</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">int</span><span class="p">]</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span><span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Train the model</span>

<span class="sd">        Args:</span>
<span class="sd">            dirpath (str): path where to put all the useful things</span>
<span class="sd">            split_params (dict): see `split_for_train`</span>
<span class="sd">            batch_size (int, optional): batch size. Defaults to 100.</span>
<span class="sd">            num_workers (int, optional): num_workers for the dataloader. Defaults to 4.</span>
<span class="sd">            max_epochs (int, optional): maximum epochs to perform. Defaults to 500.</span>
<span class="sd">            auto_lr_find (bool, optional): find initial learning rate, see  `pytorch-lightening`. Defaults to True.</span>
<span class="sd">            gradient_clip_val (Union[float,None], optional): gradient_clip_val. Defaults to None. See https://lightning.ai/docs/pytorch/stable/advanced/training_tricks.html</span>
<span class="sd">            gradient_clip_algorithm (str, optional): gradient_clip_algorithm. Defaults to &#39;norm &#39;. See https://lightning.ai/docs/pytorch/stable/advanced/training_tricks.html</span>
<span class="sd">            devices (Union[str,List[int]], optional): devices to use. Use auto if cpu or the list of gpu to use otherwise. Defaults to &#39;auto&#39;.</span>
<span class="sd">            precision  (Union[str,int], optional): precision to use. Usually 32 bit is fine but for larger model you should try &#39;bf16&#39;. If &#39;auto&#39; it will use bf16 for GPU and 32 for cpu</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;###############################################################################&#39;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;############################TRAINING###########################################&#39;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;###############################################################################&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">split_params</span> <span class="o">=</span> <span class="n">split_params</span>
        <span class="n">train</span><span class="p">,</span><span class="n">validation</span><span class="p">,</span><span class="n">test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_for_train</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">split_params</span><span class="p">)</span>
        <span class="n">accelerator</span> <span class="o">=</span> <span class="s1">&#39;gpu&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span>
        <span class="n">strategy</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span>
        <span class="k">if</span> <span class="n">accelerator</span> <span class="o">==</span> <span class="s1">&#39;gpu&#39;</span><span class="p">:</span>
            <span class="n">strategy</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span> <span class="c1">##TODO in future investigate on this</span>
            <span class="k">if</span> <span class="n">precision</span><span class="o">==</span><span class="s1">&#39;auto&#39;</span><span class="p">:</span>
                <span class="n">precision</span> <span class="o">=</span> <span class="s1">&#39;bf16&#39;</span>
            <span class="c1">#&quot;bf16&quot; ##in futuro magari inserirlo nei config, potrebbe essere che per alcuni modelli possa non andare bfloat32</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">set_float32_matmul_precision</span><span class="p">(</span><span class="s1">&#39;medium&#39;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;setting multiplication precision to medium&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">devices</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span>
            <span class="k">if</span> <span class="n">precision</span><span class="o">==</span><span class="s1">&#39;auto&#39;</span><span class="p">:</span>
                <span class="n">precision</span>  <span class="o">=</span> <span class="mi">32</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;train:</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train</span><span class="p">)</span><span class="si">}</span><span class="s1">, validation:</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">validation</span><span class="p">)</span><span class="si">}</span><span class="s1">, test:</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">test</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">accelerator</span><span class="o">==</span><span class="s1">&#39;gpu&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">num_workers</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">persistent_workers</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">persistent_workers</span> <span class="o">=</span> <span class="kc">False</span>
            
        <span class="n">train_dl</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span> <span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">drop_last</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span><span class="p">,</span><span class="n">persistent_workers</span><span class="o">=</span><span class="n">persistent_workers</span><span class="p">)</span>
        <span class="n">valid_dl</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">validation</span><span class="p">,</span> <span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span> <span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">drop_last</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span><span class="p">,</span><span class="n">persistent_workers</span><span class="o">=</span><span class="n">persistent_workers</span><span class="p">)</span>
        <span class="n">checkpoint_callback</span> <span class="o">=</span> <span class="n">ModelCheckpoint</span><span class="p">(</span><span class="n">dirpath</span><span class="o">=</span><span class="n">dirpath</span><span class="p">,</span>
                                     <span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">,</span>
                                      <span class="n">save_last</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                      <span class="n">every_n_epochs</span> <span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                      <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                      <span class="n">save_top_k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                                     <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;checkpoint&#39;</span><span class="p">)</span>
        
        
        <span class="n">logger</span> <span class="o">=</span> <span class="n">CSVLogger</span><span class="p">(</span><span class="s2">&quot;logs&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">dirpath</span><span class="p">)</span>

        <span class="n">mc</span> <span class="o">=</span> <span class="n">MetricsCallback</span><span class="p">()</span>
        <span class="c1">## TODO se ci sono 2 o piu gpu MetricsCallback non funziona (secondo me fa una istanza per ogni dataparallel che lancia e poi non riesce a recuperare info)</span>
        <span class="n">trainer</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Trainer</span><span class="p">(</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span><span class="p">,</span><span class="n">max_epochs</span><span class="o">=</span><span class="n">max_epochs</span><span class="p">,</span><span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">checkpoint_callback</span><span class="p">,</span><span class="n">mc</span><span class="p">],</span>
                             <span class="n">auto_lr_find</span><span class="o">=</span><span class="n">auto_lr_find</span><span class="p">,</span> <span class="n">accelerator</span><span class="o">=</span><span class="n">accelerator</span><span class="p">,</span><span class="n">devices</span><span class="o">=</span><span class="n">devices</span><span class="p">,</span><span class="n">strategy</span><span class="o">=</span><span class="n">strategy</span><span class="p">,</span>
                             <span class="n">precision</span><span class="o">=</span><span class="n">precision</span><span class="p">,</span><span class="n">gradient_clip_val</span><span class="o">=</span><span class="n">gradient_clip_val</span><span class="p">,</span> <span class="n">gradient_clip_algorithm</span><span class="o">=</span><span class="n">gradient_clip_algorithm</span><span class="p">)</span><span class="c1">#,devices=1)</span>

        <span class="k">if</span> <span class="n">auto_lr_find</span><span class="p">:</span>
            <span class="n">trainer</span><span class="o">.</span><span class="n">tune</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span><span class="n">train_dataloaders</span><span class="o">=</span><span class="n">train_dl</span><span class="p">,</span><span class="n">val_dataloaders</span> <span class="o">=</span> <span class="n">valid_dl</span><span class="p">)</span>

 
        <span class="n">trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">train_dl</span><span class="p">,</span><span class="n">valid_dl</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_file_best</span> <span class="o">=</span> <span class="n">checkpoint_callback</span><span class="o">.</span><span class="n">best_model_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_file_last</span> <span class="o">=</span> <span class="n">checkpoint_callback</span><span class="o">.</span><span class="n">last_model_path</span> 
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_file_last</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;There is a bug on saving last model I will try to fix it&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_file_last</span> <span class="o">=</span> <span class="n">checkpoint_callback</span><span class="o">.</span><span class="n">best_model_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;checkpoint&#39;</span><span class="p">,</span><span class="s1">&#39;last&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dirpath</span> <span class="o">=</span> <span class="n">dirpath</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">losses</span> <span class="o">=</span> <span class="n">mc</span><span class="o">.</span><span class="n">metrics</span>

        <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">()</span>
        <span class="c1">##accrocchio per multi gpu</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;__losses__.csv&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">losses</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">losses</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">losses</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">losses</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">losses</span><span class="p">)</span><span class="o">==</span><span class="nb">dict</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">losses</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">load_from_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_file_last</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;There is a problem loading the weights on file </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_file_last</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TimeSeries.inference_on_set"><a class="viewcode-back" href="../../../dsipts.data_structure.html#dsipts.data_structure.data_structure.TimeSeries.inference_on_set">[docs]</a>    <span class="k">def</span> <span class="nf">inference_on_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">batch_size</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">num_workers</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">split_params</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="nb">dict</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="nb">set</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span><span class="n">rescaling</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This function allows to get the prediction on a particular set (train, test or validation). TODO add inference on a custom dataset</span>

<span class="sd">        Args:</span>
<span class="sd">            batch_size (int, optional): barch sise. Defaults to 100.</span>
<span class="sd">            num_workers (int, optional): num workers. Defaults to 4.</span>
<span class="sd">            split_params (Union[None,dict], optional): if not None  the spliting procedure will use the given data otherwise it will use the same configuration used in train. Defaults to None.</span>
<span class="sd">            set (str, optional): trai, validation or test. Defaults to &#39;test&#39;.</span>
<span class="sd">            rescaling (bool, optional):  If rescaling is true the output will be rescaled to the initial values. . Defaults to True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pd.DataFrame: the predicted values in a pandas format</span>
<span class="sd">        &quot;&quot;&quot;</span>
     
        
        <span class="k">if</span> <span class="n">split_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;splitting using train parameters </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">split_params</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">train</span><span class="p">,</span><span class="n">validation</span><span class="p">,</span><span class="n">test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_for_train</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">split_params</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">train</span><span class="p">,</span><span class="n">validation</span><span class="p">,</span><span class="n">test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_for_train</span><span class="p">(</span><span class="o">**</span><span class="n">split_params</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">set</span><span class="o">==</span><span class="s1">&#39;test&#39;</span><span class="p">:</span>
            <span class="n">dl</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span> <span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">drop_last</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">set</span><span class="o">==</span><span class="s1">&#39;validation&#39;</span><span class="p">:</span>
            <span class="n">dl</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">validation</span><span class="p">,</span> <span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span> <span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">drop_last</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">set</span><span class="o">==</span><span class="s1">&#39;train&#39;</span><span class="p">:</span>
            <span class="n">dl</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span> <span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">drop_last</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span><span class="p">)</span>    
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;select one of train, test, or validation set&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">real</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda:0&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">))</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Device used: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">device</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">dl</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">inference</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
            <span class="n">real</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="n">real</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">real</span><span class="p">)</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">t</span>

        <span class="c1">## BxLxCx3</span>
        <span class="k">if</span> <span class="n">rescaling</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Scaling back&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_variables</span><span class="p">):</span>
                <span class="n">real</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler_num</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">real</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">real</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
                    <span class="n">res</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler_num</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">res</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">res</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">use_quantiles</span><span class="p">:</span>
            <span class="c1">##i+1 </span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span><span class="o">.</span><span class="n">melt</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;variable&#39;</span><span class="p">:</span><span class="s1">&#39;lag&#39;</span><span class="p">})</span>
            <span class="n">tot</span> <span class="o">=</span> <span class="p">[</span><span class="n">time</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_variables</span><span class="p">):</span>
                <span class="n">tot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">real</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span><span class="o">.</span><span class="n">melt</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span><span class="n">c</span><span class="p">})</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]))</span>
                <span class="n">tot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">res</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span><span class="o">.</span><span class="n">melt</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span><span class="n">c</span><span class="o">+</span><span class="s1">&#39;_low&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]))</span>
                <span class="n">tot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">res</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span><span class="o">.</span><span class="n">melt</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span><span class="n">c</span><span class="o">+</span><span class="s1">&#39;_median&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]))</span>
                <span class="n">tot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">res</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span><span class="o">.</span><span class="n">melt</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span><span class="n">c</span><span class="o">+</span><span class="s1">&#39;_high&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]))</span>

            <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">tot</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
            
        <span class="c1">## BxLxCx1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span><span class="o">.</span><span class="n">melt</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;variable&#39;</span><span class="p">:</span><span class="s1">&#39;lag&#39;</span><span class="p">})</span>
            <span class="n">tot</span> <span class="o">=</span> <span class="p">[</span><span class="n">time</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_variables</span><span class="p">):</span>
                <span class="n">tot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">real</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span><span class="o">.</span><span class="n">melt</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span><span class="n">c</span><span class="p">})</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]))</span>
                <span class="n">tot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">res</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span><span class="o">.</span><span class="n">melt</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span><span class="n">c</span><span class="o">+</span><span class="s1">&#39;_pred&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]))</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">tot</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            
        <span class="k">return</span> <span class="n">res</span></div>
<div class="viewcode-block" id="TimeSeries.inference"><a class="viewcode-back" href="../../../dsipts.data_structure.html#dsipts.data_structure.data_structure.TimeSeries.inference">[docs]</a>    <span class="k">def</span> <span class="nf">inference</span><span class="p">():</span>
        <span class="c1">##TODO implement!</span>
        <span class="k">pass</span></div>
        
<div class="viewcode-block" id="TimeSeries.save"><a class="viewcode-back" href="../../../dsipts.data_structure.html#dsipts.data_structure.data_structure.TimeSeries.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span><span class="o">-&gt;</span><span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;save the timeseries object</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (str): name of the file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Saving&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">.pkl&#39;</span><span class="p">,</span><span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">_</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">params</span><span class="p">,</span><span class="n">f</span><span class="p">)</span></div>


<div class="viewcode-block" id="TimeSeries.load"><a class="viewcode-back" href="../../../dsipts.data_structure.html#dsipts.data_structure.data_structure.TimeSeries.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model</span><span class="p">:</span><span class="n">Base</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="n">load_last</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">dirpath</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">weight_path</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">-&gt;</span><span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Load a saved model</span>

<span class="sd">        Args:</span>
<span class="sd">            model (Base): class of the model to load (it will be initiated by pytorch-lightening)</span>
<span class="sd">            filename (str): filename of the saved model</span>
<span class="sd">            load_last (bool, optional): if true the last checkpoint will be loaded otherwise the best (in the validation set). Defaults to True.</span>
<span class="sd">            dirpath (Union[str,None], optional): if None we asssume that the model is loaded from the same pc where it has been trained, otherwise we can pass the dirpath where all the stuff has been saved . Defaults to None.</span>
<span class="sd">            weight_path (Union[str, None], optional): if None the standard path will be used. Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>

            
        
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;################Loading#################################&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="o">+</span><span class="s1">&#39;.pkl&#39;</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="n">p</span><span class="p">])</span>    
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;model_configs&#39;</span><span class="p">],</span><span class="n">optim_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;optim_config&#39;</span><span class="p">],</span><span class="n">scheduler_config</span> <span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;scheduler_config&#39;</span><span class="p">]</span> <span class="p">)</span>
        
        <span class="k">if</span> <span class="n">weight_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tmp_path</span> <span class="o">=</span> <span class="n">weight_path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirpath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">load_last</span><span class="p">:</span>
                    <span class="n">tmp_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dirpath</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_file_last</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tmp_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dirpath</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_file_best</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">load_last</span><span class="p">:</span>
                    <span class="n">tmp_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_file_last</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tmp_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_file_best</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">load_from_checkpoint</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;There is a problem loading the weights on file </span><span class="si">{</span><span class="n">tmp_path</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Andrea Gobbi.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>