<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>dsipts.models.d3vae.utils &mdash; DISIPTS 0.0.1 documentation</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/sphinx_highlight.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            DISIPTS
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../modules.html">dsipts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../bash_examples.html">bash_examples package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">DISIPTS</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">dsipts.models.d3vae.utils</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for dsipts.models.d3vae.utils</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*-Encoding: utf-8 -*-</span>

<span class="kn">import</span> <span class="nn">torch.distributed</span> <span class="k">as</span> <span class="nn">dist</span>
<div class="viewcode-block" id="average_tensor"><a class="viewcode-back" href="../../../../dsipts.models.d3vae.html#dsipts.models.d3vae.utils.average_tensor">[docs]</a><span class="k">def</span> <span class="nf">average_tensor</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">is_distributed</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">is_distributed</span><span class="p">:</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">get_world_size</span><span class="p">())</span>
        <span class="n">dist</span><span class="o">.</span><span class="n">all_reduce</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">dist</span><span class="o">.</span><span class="n">ReduceOp</span><span class="o">.</span><span class="n">SUM</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">data</span> <span class="o">/=</span> <span class="n">size</span></div>

<div class="viewcode-block" id="get_stride_for_cell_type"><a class="viewcode-back" href="../../../../dsipts.models.d3vae.html#dsipts.models.d3vae.utils.get_stride_for_cell_type">[docs]</a><span class="k">def</span> <span class="nf">get_stride_for_cell_type</span><span class="p">(</span><span class="n">cell_type</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">cell_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;normal&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">cell_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;combiner&#39;</span><span class="p">):</span>
        <span class="n">stride</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">cell_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;down&#39;</span><span class="p">):</span>
        <span class="n">stride</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">elif</span> <span class="n">cell_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;up&#39;</span><span class="p">):</span>
        <span class="n">stride</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">cell_type</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">stride</span></div>


<div class="viewcode-block" id="get_input_size"><a class="viewcode-back" href="../../../../dsipts.models.d3vae.html#dsipts.models.d3vae.utils.get_input_size">[docs]</a><span class="k">def</span> <span class="nf">get_input_size</span><span class="p">(</span><span class="n">dataset</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;mnist&#39;</span><span class="p">,</span> <span class="s1">&#39;omniglot&#39;</span><span class="p">}:</span>
        <span class="k">return</span> <span class="mi">32</span>
    <span class="k">elif</span> <span class="n">dataset</span> <span class="o">==</span> <span class="s1">&#39;cifar10&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">32</span>
    <span class="k">elif</span> <span class="n">dataset</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;celeba&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">dataset</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;imagenet&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">dataset</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;lsun&#39;</span><span class="p">):</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">size</span>
    <span class="k">elif</span> <span class="n">dataset</span> <span class="o">==</span> <span class="s1">&#39;ffhq&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">256</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="groups_per_scale"><a class="viewcode-back" href="../../../../dsipts.models.d3vae.html#dsipts.models.d3vae.utils.groups_per_scale">[docs]</a><span class="k">def</span> <span class="nf">groups_per_scale</span><span class="p">(</span><span class="n">num_scales</span><span class="p">,</span> <span class="n">num_groups_per_scale</span><span class="p">,</span> <span class="n">is_adaptive</span><span class="p">,</span> <span class="n">divider</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">minimum_groups</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">g</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">num_groups_per_scale</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_scales</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">1</span>
        <span class="n">g</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_adaptive</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="o">//</span> <span class="n">divider</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">minimum_groups</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">g</span></div>



<div class="viewcode-block" id="get_arch_cells"><a class="viewcode-back" href="../../../../dsipts.models.d3vae.html#dsipts.models.d3vae.utils.get_arch_cells">[docs]</a><span class="k">def</span> <span class="nf">get_arch_cells</span><span class="p">(</span><span class="n">arch_type</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">arch_type</span> <span class="o">==</span> <span class="s1">&#39;res_elu&#39;</span><span class="p">:</span>
        <span class="n">arch_cells</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;normal_enc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res_elu&#39;</span><span class="p">,</span> <span class="s1">&#39;res_elu&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;down_enc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res_elu&#39;</span><span class="p">,</span> <span class="s1">&#39;res_elu&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;normal_dec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res_elu&#39;</span><span class="p">,</span> <span class="s1">&#39;res_elu&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;up_dec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res_elu&#39;</span><span class="p">,</span> <span class="s1">&#39;res_elu&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;normal_pre&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res_elu&#39;</span><span class="p">,</span> <span class="s1">&#39;res_elu&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;down_pre&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res_elu&#39;</span><span class="p">,</span> <span class="s1">&#39;res_elu&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;normal_post&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res_elu&#39;</span><span class="p">,</span> <span class="s1">&#39;res_elu&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;up_post&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res_elu&#39;</span><span class="p">,</span> <span class="s1">&#39;res_elu&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;ar_nn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">arch_type</span> <span class="o">==</span> <span class="s1">&#39;res_bnelu&#39;</span><span class="p">:</span>
        <span class="n">arch_cells</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;normal_enc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res_bnelu&#39;</span><span class="p">,</span> <span class="s1">&#39;res_bnelu&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;down_enc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res_bnelu&#39;</span><span class="p">,</span> <span class="s1">&#39;res_bnelu&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;normal_dec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res_bnelu&#39;</span><span class="p">,</span> <span class="s1">&#39;res_bnelu&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;up_dec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res_bnelu&#39;</span><span class="p">,</span> <span class="s1">&#39;res_bnelu&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;normal_pre&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res_bnelu&#39;</span><span class="p">,</span> <span class="s1">&#39;res_bnelu&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;down_pre&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res_bnelu&#39;</span><span class="p">,</span> <span class="s1">&#39;res_bnelu&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;normal_post&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res_bnelu&#39;</span><span class="p">,</span> <span class="s1">&#39;res_bnelu&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;up_post&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res_bnelu&#39;</span><span class="p">,</span> <span class="s1">&#39;res_bnelu&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;ar_nn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">arch_type</span> <span class="o">==</span> <span class="s1">&#39;res_bnswish&#39;</span><span class="p">:</span>
        <span class="n">arch_cells</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;normal_enc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res_bnswish&#39;</span><span class="p">,</span> <span class="s1">&#39;res_bnswish&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;down_enc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res_bnswish&#39;</span><span class="p">,</span> <span class="s1">&#39;res_bnswish&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;normal_dec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res_bnswish&#39;</span><span class="p">,</span> <span class="s1">&#39;res_bnswish&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;up_dec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res_bnswish&#39;</span><span class="p">,</span> <span class="s1">&#39;res_bnswish&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;normal_pre&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res_bnswish&#39;</span><span class="p">,</span> <span class="s1">&#39;res_bnswish&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;down_pre&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res_bnswish&#39;</span><span class="p">,</span> <span class="s1">&#39;res_bnswish&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;normal_post&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res_bnswish&#39;</span><span class="p">,</span> <span class="s1">&#39;res_bnswish&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;up_post&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res_bnswish&#39;</span><span class="p">,</span> <span class="s1">&#39;res_bnswish&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;ar_nn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">arch_type</span> <span class="o">==</span> <span class="s1">&#39;mbconv_sep&#39;</span><span class="p">:</span>
        <span class="n">arch_cells</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;normal_enc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mconv_e6k5g0&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;down_enc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mconv_e6k5g0&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;normal_dec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mconv_e6k5g0&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;up_dec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mconv_e6k5g0&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;normal_pre&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mconv_e3k5g0&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;down_pre&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mconv_e3k5g0&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;normal_post&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mconv_e3k5g0&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;up_post&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mconv_e3k5g0&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;ar_nn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">arch_type</span> <span class="o">==</span> <span class="s1">&#39;mbconv_sep11&#39;</span><span class="p">:</span>
        <span class="n">arch_cells</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;normal_enc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mconv_e6k11g0&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;down_enc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mconv_e6k11g0&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;normal_dec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mconv_e6k11g0&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;up_dec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mconv_e6k11g0&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;normal_pre&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mconv_e3k5g0&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;down_pre&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mconv_e3k5g0&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;normal_post&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mconv_e3k5g0&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;up_post&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mconv_e3k5g0&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;ar_nn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">arch_type</span> <span class="o">==</span> <span class="s1">&#39;res_mbconv&#39;</span><span class="p">:</span>
        <span class="n">arch_cells</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;normal_enc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res_bnswish&#39;</span><span class="p">,</span> <span class="s1">&#39;res_bnswish&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;down_enc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res_bnswish&#39;</span><span class="p">,</span> <span class="s1">&#39;res_bnswish&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;normal_dec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mconv_e6k5g0&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;up_dec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mconv_e6k5g0&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;normal_pre&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res_bnswish&#39;</span><span class="p">,</span> <span class="s1">&#39;res_bnswish&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;down_pre&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res_bnswish&#39;</span><span class="p">,</span> <span class="s1">&#39;res_bnswish&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;normal_post&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mconv_e3k5g0&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;up_post&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mconv_e3k5g0&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;ar_nn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">arch_type</span> <span class="o">==</span> <span class="s1">&#39;res53_mbconv&#39;</span><span class="p">:</span>
        <span class="n">arch_cells</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;normal_enc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res_bnswish5&#39;</span><span class="p">,</span> <span class="s1">&#39;res_bnswish&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;down_enc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res_bnswish5&#39;</span><span class="p">,</span> <span class="s1">&#39;res_bnswish&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;normal_dec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mconv_e6k5g0&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;up_dec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mconv_e6k5g0&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;normal_pre&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res_bnswish5&#39;</span><span class="p">,</span> <span class="s1">&#39;res_bnswish&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;down_pre&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res_bnswish5&#39;</span><span class="p">,</span> <span class="s1">&#39;res_bnswish&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;normal_post&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mconv_e3k5g0&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;up_post&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mconv_e3k5g0&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;ar_nn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">arch_type</span> <span class="o">==</span> <span class="s1">&#39;res35_mbconv&#39;</span><span class="p">:</span>
        <span class="n">arch_cells</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;normal_enc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res_bnswish&#39;</span><span class="p">,</span> <span class="s1">&#39;res_bnswish5&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;down_enc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res_bnswish&#39;</span><span class="p">,</span> <span class="s1">&#39;res_bnswish5&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;normal_dec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mconv_e6k5g0&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;up_dec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mconv_e6k5g0&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;normal_pre&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res_bnswish&#39;</span><span class="p">,</span> <span class="s1">&#39;res_bnswish5&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;down_pre&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res_bnswish&#39;</span><span class="p">,</span> <span class="s1">&#39;res_bnswish5&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;normal_post&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mconv_e3k5g0&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;up_post&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mconv_e3k5g0&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;ar_nn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">arch_type</span> <span class="o">==</span> <span class="s1">&#39;res55_mbconv&#39;</span><span class="p">:</span>
        <span class="n">arch_cells</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;normal_enc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res_bnswish5&#39;</span><span class="p">,</span> <span class="s1">&#39;res_bnswish5&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;down_enc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res_bnswish5&#39;</span><span class="p">,</span> <span class="s1">&#39;res_bnswish5&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;normal_dec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mconv_e6k5g0&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;up_dec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mconv_e6k5g0&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;normal_pre&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res_bnswish5&#39;</span><span class="p">,</span> <span class="s1">&#39;res_bnswish5&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;down_pre&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res_bnswish5&#39;</span><span class="p">,</span> <span class="s1">&#39;res_bnswish5&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;normal_post&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mconv_e3k5g0&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;up_post&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mconv_e3k5g0&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;ar_nn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">arch_type</span> <span class="o">==</span> <span class="s1">&#39;res_mbconv9&#39;</span><span class="p">:</span>
        <span class="n">arch_cells</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;normal_enc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res_bnswish&#39;</span><span class="p">,</span> <span class="s1">&#39;res_bnswish&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;down_enc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res_bnswish&#39;</span><span class="p">,</span> <span class="s1">&#39;res_bnswish&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;normal_dec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mconv_e6k9g0&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;up_dec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mconv_e6k9g0&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;normal_pre&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res_bnswish&#39;</span><span class="p">,</span> <span class="s1">&#39;res_bnswish&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;down_pre&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res_bnswish&#39;</span><span class="p">,</span> <span class="s1">&#39;res_bnswish&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;normal_post&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mconv_e3k9g0&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;up_post&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mconv_e3k9g0&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;ar_nn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">arch_type</span> <span class="o">==</span> <span class="s1">&#39;mbconv_res&#39;</span><span class="p">:</span>
        <span class="n">arch_cells</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;normal_enc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mconv_e6k5g0&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;down_enc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mconv_e6k5g0&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;normal_dec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res_bnswish&#39;</span><span class="p">,</span> <span class="s1">&#39;res_bnswish&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;up_dec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res_bnswish&#39;</span><span class="p">,</span> <span class="s1">&#39;res_bnswish&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;normal_pre&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mconv_e3k5g0&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;down_pre&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mconv_e3k5g0&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;normal_post&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res_bnswish&#39;</span><span class="p">,</span> <span class="s1">&#39;res_bnswish&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;up_post&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res_bnswish&#39;</span><span class="p">,</span> <span class="s1">&#39;res_bnswish&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;ar_nn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">arch_type</span> <span class="o">==</span> <span class="s1">&#39;mbconv_den&#39;</span><span class="p">:</span>
        <span class="n">arch_cells</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;normal_enc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mconv_e6k5g0&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;down_enc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mconv_e6k5g0&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;normal_dec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mconv_e6k5g0&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;up_dec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mconv_e6k5g0&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;normal_pre&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mconv_e3k5g8&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;down_pre&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mconv_e3k5g8&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;normal_post&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mconv_e3k5g8&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;up_post&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mconv_e3k5g8&#39;</span><span class="p">]</span>
        <span class="n">arch_cells</span><span class="p">[</span><span class="s1">&#39;ar_nn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
    <span class="k">return</span> <span class="n">arch_cells</span></div>


<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Authors:</span>
<span class="sd">    Li,Yan (liyan22021121@gmail.com)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">import logging</span>
<span class="sd">import os</span>
<span class="sd">import shutil</span>
<span class="sd">import time</span>
<span class="sd">from datetime import timedelta</span>
<span class="sd">import sys</span>

<span class="sd">import torch</span>
<span class="sd">import torch.nn as nn</span>
<span class="sd">import numpy as np</span>
<span class="sd">import torch.distributed as dist</span>

<span class="sd">import torch.nn.functional as F</span>
<span class="sd">from distributions import Normal, DiscMixLogistic</span>

<span class="sd">class AvgrageMeter(object):</span>
<span class="sd">    def __init__(self):</span>
<span class="sd">        self.reset()</span>

<span class="sd">    def reset(self):</span>
<span class="sd">        self.avg = 0</span>
<span class="sd">        self.sum = 0</span>
<span class="sd">        self.cnt = 0</span>

<span class="sd">    def update(self, val, n=1):</span>
<span class="sd">        self.sum += val * n</span>
<span class="sd">        self.cnt += n</span>
<span class="sd">        self.avg = self.sum / self.cnt</span>


<span class="sd">class ExpMovingAvgrageMeter(object):</span>

<span class="sd">    def __init__(self, momentum=0.9):</span>
<span class="sd">        self.momentum = momentum</span>
<span class="sd">        self.reset()</span>

<span class="sd">    def reset(self):</span>
<span class="sd">        self.avg = 0</span>

<span class="sd">    def update(self, val):</span>
<span class="sd">        self.avg = (1. - self.momentum) * self.avg + self.momentum * val</span>


<span class="sd">class DummyDDP(nn.Module):</span>
<span class="sd">    def __init__(self, model):</span>
<span class="sd">        super(DummyDDP, self).__init__()</span>
<span class="sd">        self.module = model</span>

<span class="sd">    def forward(self, *input, **kwargs):</span>
<span class="sd">        return self.module(*input, **kwargs)</span>


<span class="sd">def count_parameters_in_M(model):</span>
<span class="sd">    return np.sum(np.prod(v.size()) for name, v in model.named_parameters() if &quot;auxiliary&quot; not in name)/1e6</span>


<span class="sd">def save_checkpoint(state, is_best, save):</span>
<span class="sd">    filename = os.path.join(save, &#39;checkpoint.pth.tar&#39;)</span>
<span class="sd">    torch.save(state, filename)</span>
<span class="sd">    if is_best:</span>
<span class="sd">        best_filename = os.path.join(save, &#39;model_best.pth.tar&#39;)</span>
<span class="sd">        shutil.copyfile(filename, best_filename)</span>


<span class="sd">def save(model, model_path):</span>
<span class="sd">    torch.save(model.state_dict(), model_path)</span>


<span class="sd">def load(model, model_path):</span>
<span class="sd">    model.load_state_dict(torch.load(model_path))</span>


<span class="sd">def create_exp_dir(path, scripts_to_save=None):</span>
<span class="sd">    if not os.path.exists(path):</span>
<span class="sd">        os.makedirs(path, exist_ok=True)</span>
<span class="sd">    print(&#39;Experiment dir : {}&#39;.format(path))</span>

<span class="sd">    if scripts_to_save is not None:</span>
<span class="sd">        if not os.path.exists(os.path.join(path, &#39;scripts&#39;)):</span>
<span class="sd">            os.mkdir(os.path.join(path, &#39;scripts&#39;))</span>
<span class="sd">        for script in scripts_to_save:</span>
<span class="sd">            dst_file = os.path.join(path, &#39;scripts&#39;, os.path.basename(script))</span>
<span class="sd">            shutil.copyfile(script, dst_file)</span>


<span class="sd">class Logger(object):</span>
<span class="sd">    def __init__(self, rank, save):</span>
<span class="sd">        # other libraries may set logging before arriving at this line.</span>
<span class="sd">        # by reloading logging, we can get rid of previous configs set by other libraries.</span>
<span class="sd">        from importlib import reload</span>
<span class="sd">        reload(logging)</span>
<span class="sd">        self.rank = rank</span>
<span class="sd">        if self.rank == 0:</span>
<span class="sd">            log_format = &#39;%(asctime)s %(message)s&#39;</span>
<span class="sd">            logging.basicConfig(stream=sys.stdout, level=logging.INFO,</span>
<span class="sd">                                format=log_format, datefmt=&#39;%m/%d %I:%M:%S %p&#39;)</span>
<span class="sd">            fh = logging.FileHandler(os.path.join(save, &#39;log.txt&#39;))</span>
<span class="sd">            fh.setFormatter(logging.Formatter(log_format))</span>
<span class="sd">            logging.getLogger().addHandler(fh)</span>
<span class="sd">            self.start_time = time.time()</span>

<span class="sd">    def info(self, string, *args):</span>
<span class="sd">        if self.rank == 0:</span>
<span class="sd">            elapsed_time = time.time() - self.start_time</span>
<span class="sd">            elapsed_time = time.strftime(</span>
<span class="sd">                &#39;(Elapsed: %H:%M:%S) &#39;, time.gmtime(elapsed_time))</span>
<span class="sd">            if isinstance(string, str):</span>
<span class="sd">                string = elapsed_time + string</span>
<span class="sd">            else:</span>
<span class="sd">                logging.info(elapsed_time)</span>
<span class="sd">            logging.info(string, *args)</span>


<span class="sd">def reduce_tensor(tensor, world_size):</span>
<span class="sd">    rt = tensor.clone()</span>
<span class="sd">    dist.all_reduce(rt, op=dist.ReduceOp.SUM)</span>
<span class="sd">    rt /= world_size</span>
<span class="sd">    return rt</span>


<span class="sd">def get_stride_for_cell_type(cell_type):</span>
<span class="sd">    if cell_type.startswith(&#39;normal&#39;) or cell_type.startswith(&#39;combiner&#39;):</span>
<span class="sd">        stride = 1</span>
<span class="sd">    elif cell_type.startswith(&#39;down&#39;):</span>
<span class="sd">        stride = 2</span>
<span class="sd">    elif cell_type.startswith(&#39;up&#39;):</span>
<span class="sd">        stride = -1</span>
<span class="sd">    else:</span>
<span class="sd">        raise NotImplementedError(cell_type)</span>

<span class="sd">    return stride</span>


<span class="sd">def get_cout(cin, stride):</span>
<span class="sd">    if stride == 1:</span>
<span class="sd">        cout = cin</span>
<span class="sd">    elif stride == -1:</span>
<span class="sd">        cout = cin // 2</span>
<span class="sd">    elif stride == 2:</span>
<span class="sd">        cout = 2 * cin</span>
<span class="sd">    return cout</span>


<span class="sd">def kl_balancer_coeff(num_scales, groups_per_scale, fun):</span>
<span class="sd">    if fun == &#39;equal&#39;:</span>
<span class="sd">        coeff = torch.cat([torch.ones(groups_per_scale[num_scales - i - 1]) for i in range(num_scales)], dim=0).cuda()</span>
<span class="sd">    elif fun == &#39;linear&#39;:</span>
<span class="sd">        coeff = torch.cat([(2 ** i) * torch.ones(groups_per_scale[num_scales - i - 1]) for i in range(num_scales)], dim=0).cuda()</span>
<span class="sd">    elif fun == &#39;sqrt&#39;:</span>
<span class="sd">        coeff = torch.cat([np.sqrt(2 ** i) * torch.ones(groups_per_scale[num_scales - i - 1]) for i in range(num_scales)], dim=0).cuda()</span>
<span class="sd">    elif fun == &#39;square&#39;:</span>
<span class="sd">        coeff = torch.cat([np.square(2 ** i) / groups_per_scale[num_scales - i - 1] * torch.ones(groups_per_scale[num_scales - i - 1]) for i in range(num_scales)], dim=0).cuda()</span>
<span class="sd">    else:</span>
<span class="sd">        raise NotImplementedError</span>
<span class="sd">    # convert min to 1.</span>
<span class="sd">    coeff /= torch.min(coeff)</span>
<span class="sd">    return coeff</span>


<span class="sd">def kl_per_group(kl_all):</span>
<span class="sd">    kl_vals = torch.mean(kl_all, dim=0)</span>
<span class="sd">    kl_coeff_i = torch.abs(kl_all)</span>
<span class="sd">    kl_coeff_i = torch.mean(kl_coeff_i, dim=0, keepdim=True) + 0.01</span>

<span class="sd">    return kl_coeff_i, kl_vals</span>


<span class="sd">def kl_balancer(kl_all, kl_coeff=1.0, kl_balance=False, alpha_i=None):</span>
<span class="sd">    if kl_balance and kl_coeff &lt; 1.0:</span>
<span class="sd">        alpha_i = alpha_i.unsqueeze(0)</span>

<span class="sd">        kl_all = torch.stack(kl_all, dim=1)</span>
<span class="sd">        kl_coeff_i, kl_vals = kl_per_group(kl_all)</span>
<span class="sd">        total_kl = torch.sum(kl_coeff_i)</span>

<span class="sd">        kl_coeff_i = kl_coeff_i / alpha_i * total_kl</span>
<span class="sd">        kl_coeff_i = kl_coeff_i / torch.mean(kl_coeff_i, dim=1, keepdim=True)</span>
<span class="sd">        kl = torch.sum(kl_all * kl_coeff_i.detach(), dim=1)</span>

<span class="sd">        # for reporting</span>
<span class="sd">        kl_coeffs = kl_coeff_i.squeeze(0)</span>
<span class="sd">    else:</span>
<span class="sd">        kl_all = torch.stack(kl_all, dim=1)</span>
<span class="sd">        kl_vals = torch.mean(kl_all, dim=0)</span>
<span class="sd">        kl = torch.sum(kl_all, dim=1)</span>
<span class="sd">        kl_coeffs = torch.ones(size=(len(kl_vals),))</span>

<span class="sd">    return kl_coeff * kl, kl_coeffs, kl_vals</span>


<span class="sd">def kl_coeff(step, total_step, constant_step, min_kl_coeff):</span>
<span class="sd">    return max(min((step - constant_step) / total_step, 1.0), min_kl_coeff)</span>


<span class="sd">def log_iw(decoder, x, log_q, log_p, crop=False):</span>
<span class="sd">    recon = reconstruction_loss(decoder, x, crop)</span>
<span class="sd">    return - recon - log_q + log_p</span>


<span class="sd">def reconstruction_loss(decoder, x, crop=False):</span>
<span class="sd">    </span>

<span class="sd">    recon = decoder.log_prob(x)</span>

<span class="sd">    if crop:</span>
<span class="sd">        recon = recon[:, :, 2:30, 2:30]</span>
<span class="sd">    </span>
<span class="sd">    if isinstance(decoder, DiscMixLogistic):</span>
<span class="sd">        return - torch.sum(recon, dim=[1, 2])    # summation over RGB is done.</span>
<span class="sd">    else:</span>
<span class="sd">        return - torch.sum(recon, dim=[1, 2, 3])</span>


<span class="sd">def tile_image(batch_image, n):</span>
<span class="sd">    assert n * n == batch_image.size(0)</span>
<span class="sd">    channels, height, width = batch_image.size(1), batch_image.size(2), batch_image.size(3)</span>
<span class="sd">    batch_image = batch_image.view(n, n, channels, height, width)</span>
<span class="sd">    batch_image = batch_image.permute(2, 0, 3, 1, 4)                              # n, height, n, width, c</span>
<span class="sd">    batch_image = batch_image.contiguous().view(channels, n * height, n * width)</span>
<span class="sd">    return batch_image</span>


<span class="sd">def average_gradients(params, is_distributed):</span>
<span class="sd">    &quot;&quot;&quot; Gradient averaging. &quot;&quot;&quot;</span>
<span class="sd">    if is_distributed:</span>
<span class="sd">        size = float(dist.get_world_size())</span>
<span class="sd">        for param in params:</span>
<span class="sd">            if param.requires_grad:</span>
<span class="sd">                # print(param)</span>
<span class="sd">                dist.all_reduce(param, op=dist.ReduceOp.SUM)</span>
<span class="sd">                param = param//size</span>


<span class="sd">def average_params(params, is_distributed):</span>
<span class="sd">    &quot;&quot;&quot; parameter averaging. &quot;&quot;&quot;</span>
<span class="sd">    if is_distributed:</span>
<span class="sd">        size = float(dist.get_world_size())</span>
<span class="sd">        for param in params:</span>
<span class="sd">            dist.all_reduce(param.data, op=dist.ReduceOp.SUM)</span>
<span class="sd">            param.data /= size</span>




<span class="sd">def one_hot(indices, depth, dim):</span>
<span class="sd">    indices = indices.unsqueeze(dim)</span>
<span class="sd">    size = list(indices.size())</span>
<span class="sd">    size[dim] = depth</span>
<span class="sd">    y_onehot = torch.zeros(size).cuda()</span>
<span class="sd">    y_onehot.zero_()</span>
<span class="sd">    y_onehot.scatter_(dim, indices, 1)</span>

<span class="sd">    return y_onehot</span>


<span class="sd">def num_output(dataset):</span>
<span class="sd">    if dataset in {&#39;mnist&#39;, &#39;omniglot&#39;}:</span>
<span class="sd">        return 28 * 28</span>
<span class="sd">    elif dataset == &#39;cifar10&#39;:</span>
<span class="sd">        return 3 * 32 * 32</span>
<span class="sd">    elif dataset.startswith(&#39;celeba&#39;) or dataset.startswith(&#39;imagenet&#39;) or dataset.startswith(&#39;lsun&#39;):</span>
<span class="sd">        size = int(dataset.split(&#39;_&#39;)[-1])</span>
<span class="sd">        return 3 * size * size</span>
<span class="sd">    elif dataset == &#39;ffhq&#39;:</span>
<span class="sd">        return 3 * 256 * 256</span>
<span class="sd">    else:</span>
<span class="sd">        raise NotImplementedError</span>


<span class="sd">def get_input_size(dataset):</span>
<span class="sd">    if dataset in {&#39;mnist&#39;, &#39;omniglot&#39;}:</span>
<span class="sd">        return 32</span>
<span class="sd">    elif dataset == &#39;cifar10&#39;:</span>
<span class="sd">        return 32</span>
<span class="sd">    elif dataset.startswith(&#39;celeba&#39;) or dataset.startswith(&#39;imagenet&#39;) or dataset.startswith(&#39;lsun&#39;):</span>
<span class="sd">        size = int(dataset.split(&#39;_&#39;)[-1])</span>
<span class="sd">        return size</span>
<span class="sd">    elif dataset == &#39;ffhq&#39;:</span>
<span class="sd">        return 256</span>
<span class="sd">    else:</span>
<span class="sd">        raise NotImplementedError</span>


<span class="sd">def pre_process(x, num_bits):</span>
<span class="sd">    if num_bits != 8:</span>
<span class="sd">        x = torch.floor(x * 255 / 2 ** (8 - num_bits))</span>
<span class="sd">        x /= (2 ** num_bits - 1)</span>
<span class="sd">    return x</span>


<span class="sd">def get_arch_cells(arch_type):</span>
<span class="sd">    if arch_type == &#39;res_elu&#39;:</span>
<span class="sd">        arch_cells = dict()</span>
<span class="sd">        arch_cells[&#39;normal_enc&#39;] = [&#39;res_elu&#39;, &#39;res_elu&#39;]</span>
<span class="sd">        arch_cells[&#39;down_enc&#39;] = [&#39;res_elu&#39;, &#39;res_elu&#39;]</span>
<span class="sd">        arch_cells[&#39;normal_dec&#39;] = [&#39;res_elu&#39;, &#39;res_elu&#39;]</span>
<span class="sd">        arch_cells[&#39;up_dec&#39;] = [&#39;res_elu&#39;, &#39;res_elu&#39;]</span>
<span class="sd">        arch_cells[&#39;normal_pre&#39;] = [&#39;res_elu&#39;, &#39;res_elu&#39;]</span>
<span class="sd">        arch_cells[&#39;down_pre&#39;] = [&#39;res_elu&#39;, &#39;res_elu&#39;]</span>
<span class="sd">        arch_cells[&#39;normal_post&#39;] = [&#39;res_elu&#39;, &#39;res_elu&#39;]</span>
<span class="sd">        arch_cells[&#39;up_post&#39;] = [&#39;res_elu&#39;, &#39;res_elu&#39;]</span>
<span class="sd">        arch_cells[&#39;ar_nn&#39;] = [&#39;&#39;]</span>
<span class="sd">    elif arch_type == &#39;res_bnelu&#39;:</span>
<span class="sd">        arch_cells = dict()</span>
<span class="sd">        arch_cells[&#39;normal_enc&#39;] = [&#39;res_bnelu&#39;, &#39;res_bnelu&#39;]</span>
<span class="sd">        arch_cells[&#39;down_enc&#39;] = [&#39;res_bnelu&#39;, &#39;res_bnelu&#39;]</span>
<span class="sd">        arch_cells[&#39;normal_dec&#39;] = [&#39;res_bnelu&#39;, &#39;res_bnelu&#39;]</span>
<span class="sd">        arch_cells[&#39;up_dec&#39;] = [&#39;res_bnelu&#39;, &#39;res_bnelu&#39;]</span>
<span class="sd">        arch_cells[&#39;normal_pre&#39;] = [&#39;res_bnelu&#39;, &#39;res_bnelu&#39;]</span>
<span class="sd">        arch_cells[&#39;down_pre&#39;] = [&#39;res_bnelu&#39;, &#39;res_bnelu&#39;]</span>
<span class="sd">        arch_cells[&#39;normal_post&#39;] = [&#39;res_bnelu&#39;, &#39;res_bnelu&#39;]</span>
<span class="sd">        arch_cells[&#39;up_post&#39;] = [&#39;res_bnelu&#39;, &#39;res_bnelu&#39;]</span>
<span class="sd">        arch_cells[&#39;ar_nn&#39;] = [&#39;&#39;]</span>
<span class="sd">    elif arch_type == &#39;res_bnswish&#39;:</span>
<span class="sd">        arch_cells = dict()</span>
<span class="sd">        arch_cells[&#39;normal_enc&#39;] = [&#39;res_bnswish&#39;, &#39;res_bnswish&#39;]</span>
<span class="sd">        arch_cells[&#39;down_enc&#39;] = [&#39;res_bnswish&#39;, &#39;res_bnswish&#39;]</span>
<span class="sd">        arch_cells[&#39;normal_dec&#39;] = [&#39;res_bnswish&#39;, &#39;res_bnswish&#39;]</span>
<span class="sd">        arch_cells[&#39;up_dec&#39;] = [&#39;res_bnswish&#39;, &#39;res_bnswish&#39;]</span>
<span class="sd">        arch_cells[&#39;normal_pre&#39;] = [&#39;res_bnswish&#39;, &#39;res_bnswish&#39;]</span>
<span class="sd">        arch_cells[&#39;down_pre&#39;] = [&#39;res_bnswish&#39;, &#39;res_bnswish&#39;]</span>
<span class="sd">        arch_cells[&#39;normal_post&#39;] = [&#39;res_bnswish&#39;, &#39;res_bnswish&#39;]</span>
<span class="sd">        arch_cells[&#39;up_post&#39;] = [&#39;res_bnswish&#39;, &#39;res_bnswish&#39;]</span>
<span class="sd">        arch_cells[&#39;ar_nn&#39;] = [&#39;&#39;]</span>
<span class="sd">    elif arch_type == &#39;mbconv_sep&#39;:</span>
<span class="sd">        arch_cells = dict()</span>
<span class="sd">        arch_cells[&#39;normal_enc&#39;] = [&#39;mconv_e6k5g0&#39;]</span>
<span class="sd">        arch_cells[&#39;down_enc&#39;] = [&#39;mconv_e6k5g0&#39;]</span>
<span class="sd">        arch_cells[&#39;normal_dec&#39;] = [&#39;mconv_e6k5g0&#39;]</span>
<span class="sd">        arch_cells[&#39;up_dec&#39;] = [&#39;mconv_e6k5g0&#39;]</span>
<span class="sd">        arch_cells[&#39;normal_pre&#39;] = [&#39;mconv_e3k5g0&#39;]</span>
<span class="sd">        arch_cells[&#39;down_pre&#39;] = [&#39;mconv_e3k5g0&#39;]</span>
<span class="sd">        arch_cells[&#39;normal_post&#39;] = [&#39;mconv_e3k5g0&#39;]</span>
<span class="sd">        arch_cells[&#39;up_post&#39;] = [&#39;mconv_e3k5g0&#39;]</span>
<span class="sd">        arch_cells[&#39;ar_nn&#39;] = [&#39;&#39;]</span>
<span class="sd">    elif arch_type == &#39;mbconv_sep11&#39;:</span>
<span class="sd">        arch_cells = dict()</span>
<span class="sd">        arch_cells[&#39;normal_enc&#39;] = [&#39;mconv_e6k11g0&#39;]</span>
<span class="sd">        arch_cells[&#39;down_enc&#39;] = [&#39;mconv_e6k11g0&#39;]</span>
<span class="sd">        arch_cells[&#39;normal_dec&#39;] = [&#39;mconv_e6k11g0&#39;]</span>
<span class="sd">        arch_cells[&#39;up_dec&#39;] = [&#39;mconv_e6k11g0&#39;]</span>
<span class="sd">        arch_cells[&#39;normal_pre&#39;] = [&#39;mconv_e3k5g0&#39;]</span>
<span class="sd">        arch_cells[&#39;down_pre&#39;] = [&#39;mconv_e3k5g0&#39;]</span>
<span class="sd">        arch_cells[&#39;normal_post&#39;] = [&#39;mconv_e3k5g0&#39;]</span>
<span class="sd">        arch_cells[&#39;up_post&#39;] = [&#39;mconv_e3k5g0&#39;]</span>
<span class="sd">        arch_cells[&#39;ar_nn&#39;] = [&#39;&#39;]</span>
<span class="sd">    elif arch_type == &#39;res_mbconv&#39;:</span>
<span class="sd">        arch_cells = dict()</span>
<span class="sd">        arch_cells[&#39;normal_enc&#39;] = [&#39;res_bnswish&#39;, &#39;res_bnswish&#39;]</span>
<span class="sd">        arch_cells[&#39;down_enc&#39;] = [&#39;res_bnswish&#39;, &#39;res_bnswish&#39;]</span>
<span class="sd">        arch_cells[&#39;normal_dec&#39;] = [&#39;mconv_e6k5g0&#39;]</span>
<span class="sd">        arch_cells[&#39;up_dec&#39;] = [&#39;mconv_e6k5g0&#39;]</span>
<span class="sd">        arch_cells[&#39;normal_pre&#39;] = [&#39;res_bnswish&#39;, &#39;res_bnswish&#39;]</span>
<span class="sd">        arch_cells[&#39;down_pre&#39;] = [&#39;res_bnswish&#39;, &#39;res_bnswish&#39;]</span>
<span class="sd">        arch_cells[&#39;normal_post&#39;] = [&#39;mconv_e3k5g0&#39;]</span>
<span class="sd">        arch_cells[&#39;up_post&#39;] = [&#39;mconv_e3k5g0&#39;]</span>
<span class="sd">        arch_cells[&#39;ar_nn&#39;] = [&#39;&#39;]</span>
<span class="sd">    elif arch_type == &#39;res53_mbconv&#39;:</span>
<span class="sd">        arch_cells = dict()</span>
<span class="sd">        arch_cells[&#39;normal_enc&#39;] = [&#39;res_bnswish5&#39;, &#39;res_bnswish&#39;]</span>
<span class="sd">        arch_cells[&#39;down_enc&#39;] = [&#39;res_bnswish5&#39;, &#39;res_bnswish&#39;]</span>
<span class="sd">        arch_cells[&#39;normal_dec&#39;] = [&#39;mconv_e6k5g0&#39;]</span>
<span class="sd">        arch_cells[&#39;up_dec&#39;] = [&#39;mconv_e6k5g0&#39;]</span>
<span class="sd">        arch_cells[&#39;normal_pre&#39;] = [&#39;res_bnswish5&#39;, &#39;res_bnswish&#39;]</span>
<span class="sd">        arch_cells[&#39;down_pre&#39;] = [&#39;res_bnswish5&#39;, &#39;res_bnswish&#39;]</span>
<span class="sd">        arch_cells[&#39;normal_post&#39;] = [&#39;mconv_e3k5g0&#39;]</span>
<span class="sd">        arch_cells[&#39;up_post&#39;] = [&#39;mconv_e3k5g0&#39;]</span>
<span class="sd">        arch_cells[&#39;ar_nn&#39;] = [&#39;&#39;]</span>
<span class="sd">    elif arch_type == &#39;res35_mbconv&#39;:</span>
<span class="sd">        arch_cells = dict()</span>
<span class="sd">        arch_cells[&#39;normal_enc&#39;] = [&#39;res_bnswish&#39;, &#39;res_bnswish5&#39;]</span>
<span class="sd">        arch_cells[&#39;down_enc&#39;] = [&#39;res_bnswish&#39;, &#39;res_bnswish5&#39;]</span>
<span class="sd">        arch_cells[&#39;normal_dec&#39;] = [&#39;mconv_e6k5g0&#39;]</span>
<span class="sd">        arch_cells[&#39;up_dec&#39;] = [&#39;mconv_e6k5g0&#39;]</span>
<span class="sd">        arch_cells[&#39;normal_pre&#39;] = [&#39;res_bnswish&#39;, &#39;res_bnswish5&#39;]</span>
<span class="sd">        arch_cells[&#39;down_pre&#39;] = [&#39;res_bnswish&#39;, &#39;res_bnswish5&#39;]</span>
<span class="sd">        arch_cells[&#39;normal_post&#39;] = [&#39;mconv_e3k5g0&#39;]</span>
<span class="sd">        arch_cells[&#39;up_post&#39;] = [&#39;mconv_e3k5g0&#39;]</span>
<span class="sd">        arch_cells[&#39;ar_nn&#39;] = [&#39;&#39;]</span>
<span class="sd">    elif arch_type == &#39;res55_mbconv&#39;:</span>
<span class="sd">        arch_cells = dict()</span>
<span class="sd">        arch_cells[&#39;normal_enc&#39;] = [&#39;res_bnswish5&#39;, &#39;res_bnswish5&#39;]</span>
<span class="sd">        arch_cells[&#39;down_enc&#39;] = [&#39;res_bnswish5&#39;, &#39;res_bnswish5&#39;]</span>
<span class="sd">        arch_cells[&#39;normal_dec&#39;] = [&#39;mconv_e6k5g0&#39;]</span>
<span class="sd">        arch_cells[&#39;up_dec&#39;] = [&#39;mconv_e6k5g0&#39;]</span>
<span class="sd">        arch_cells[&#39;normal_pre&#39;] = [&#39;res_bnswish5&#39;, &#39;res_bnswish5&#39;]</span>
<span class="sd">        arch_cells[&#39;down_pre&#39;] = [&#39;res_bnswish5&#39;, &#39;res_bnswish5&#39;]</span>
<span class="sd">        arch_cells[&#39;normal_post&#39;] = [&#39;mconv_e3k5g0&#39;]</span>
<span class="sd">        arch_cells[&#39;up_post&#39;] = [&#39;mconv_e3k5g0&#39;]</span>
<span class="sd">        arch_cells[&#39;ar_nn&#39;] = [&#39;&#39;]</span>
<span class="sd">    elif arch_type == &#39;res_mbconv9&#39;:</span>
<span class="sd">        arch_cells = dict()</span>
<span class="sd">        arch_cells[&#39;normal_enc&#39;] = [&#39;res_bnswish&#39;, &#39;res_bnswish&#39;]</span>
<span class="sd">        arch_cells[&#39;down_enc&#39;] = [&#39;res_bnswish&#39;, &#39;res_bnswish&#39;]</span>
<span class="sd">        arch_cells[&#39;normal_dec&#39;] = [&#39;mconv_e6k9g0&#39;]</span>
<span class="sd">        arch_cells[&#39;up_dec&#39;] = [&#39;mconv_e6k9g0&#39;]</span>
<span class="sd">        arch_cells[&#39;normal_pre&#39;] = [&#39;res_bnswish&#39;, &#39;res_bnswish&#39;]</span>
<span class="sd">        arch_cells[&#39;down_pre&#39;] = [&#39;res_bnswish&#39;, &#39;res_bnswish&#39;]</span>
<span class="sd">        arch_cells[&#39;normal_post&#39;] = [&#39;mconv_e3k9g0&#39;]</span>
<span class="sd">        arch_cells[&#39;up_post&#39;] = [&#39;mconv_e3k9g0&#39;]</span>
<span class="sd">        arch_cells[&#39;ar_nn&#39;] = [&#39;&#39;]</span>
<span class="sd">    elif arch_type == &#39;mbconv_res&#39;:</span>
<span class="sd">        arch_cells = dict()</span>
<span class="sd">        arch_cells[&#39;normal_enc&#39;] = [&#39;mconv_e6k5g0&#39;]</span>
<span class="sd">        arch_cells[&#39;down_enc&#39;] = [&#39;mconv_e6k5g0&#39;]</span>
<span class="sd">        arch_cells[&#39;normal_dec&#39;] = [&#39;res_bnswish&#39;, &#39;res_bnswish&#39;]</span>
<span class="sd">        arch_cells[&#39;up_dec&#39;] = [&#39;res_bnswish&#39;, &#39;res_bnswish&#39;]</span>
<span class="sd">        arch_cells[&#39;normal_pre&#39;] = [&#39;mconv_e3k5g0&#39;]</span>
<span class="sd">        arch_cells[&#39;down_pre&#39;] = [&#39;mconv_e3k5g0&#39;]</span>
<span class="sd">        arch_cells[&#39;normal_post&#39;] = [&#39;res_bnswish&#39;, &#39;res_bnswish&#39;]</span>
<span class="sd">        arch_cells[&#39;up_post&#39;] = [&#39;res_bnswish&#39;, &#39;res_bnswish&#39;]</span>
<span class="sd">        arch_cells[&#39;ar_nn&#39;] = [&#39;&#39;]</span>
<span class="sd">    elif arch_type == &#39;mbconv_den&#39;:</span>
<span class="sd">        arch_cells = dict()</span>
<span class="sd">        arch_cells[&#39;normal_enc&#39;] = [&#39;mconv_e6k5g0&#39;]</span>
<span class="sd">        arch_cells[&#39;down_enc&#39;] = [&#39;mconv_e6k5g0&#39;]</span>
<span class="sd">        arch_cells[&#39;normal_dec&#39;] = [&#39;mconv_e6k5g0&#39;]</span>
<span class="sd">        arch_cells[&#39;up_dec&#39;] = [&#39;mconv_e6k5g0&#39;]</span>
<span class="sd">        arch_cells[&#39;normal_pre&#39;] = [&#39;mconv_e3k5g8&#39;]</span>
<span class="sd">        arch_cells[&#39;down_pre&#39;] = [&#39;mconv_e3k5g8&#39;]</span>
<span class="sd">        arch_cells[&#39;normal_post&#39;] = [&#39;mconv_e3k5g8&#39;]</span>
<span class="sd">        arch_cells[&#39;up_post&#39;] = [&#39;mconv_e3k5g8&#39;]</span>
<span class="sd">        arch_cells[&#39;ar_nn&#39;] = [&#39;&#39;]</span>
<span class="sd">    else:</span>
<span class="sd">        raise NotImplementedError</span>
<span class="sd">    return arch_cells</span>


<span class="sd">def groups_per_scale(num_scales, num_groups_per_scale, is_adaptive, divider=2, minimum_groups=1):</span>
<span class="sd">    g = []</span>
<span class="sd">    n = num_groups_per_scale</span>
<span class="sd">    for s in range(num_scales):</span>
<span class="sd">        assert n &gt;= 1</span>
<span class="sd">        g.append(n)</span>
<span class="sd">        if is_adaptive:</span>
<span class="sd">            n = n // divider</span>
<span class="sd">            n = max(minimum_groups, n)</span>
<span class="sd">    return g</span>
<span class="sd">&#39;&#39;&#39;</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Andrea Gobbi.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>